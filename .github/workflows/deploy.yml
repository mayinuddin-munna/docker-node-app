name: Test EC2 Connection

on:
    push:
        branches: [main]

jobs:
    test-and-deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Trim EC2_HOST secret
              id: trim-host
              run: |
                  # Trim the host secret
                  HOST='${{ secrets.EC2_HOST }}'
                  TRIMMED_HOST=$(echo "$HOST" | xargs)
                  if [ -z "$TRIMMED_HOST" ]; then
                    echo "ERROR: EC2_HOST secret is empty or not set."
                    exit 1
                  fi
                  # Mask the output to avoid leaking the secret
                  echo "::add-mask::$TRIMMED_HOST"
                  echo "EC2_HOST secret is set and trimmed."
                  echo "::set-output name=host::$TRIMMED_HOST"

            - name: Test connectivity to EC2 host
              run: |
                  HOST="${{ steps.trim-host.outputs.host }}"
                  echo "Testing connectivity to $HOST"
                  # Use nc to test port 22 with a 5 second timeout
                  if nc -z -w 5 "$HOST" 22; then
                    echo "✅ Port 22 is open on $HOST"
                  else
                    echo "❌ Port 22 is not reachable on $HOST"
                    exit 1
                  fi

            - name: Attempt SSH connection
              uses: appleboy/ssh-action@v1
              with:
                  host: ${{ steps.trim-host.outputs.host }}
                  username: ubuntu
                  key: ${{ secrets.EC2_SSH_KEY }}
                  timeout: 30
                  command_timeout: 30
                  script: |
                      echo "✅ Connected to $(hostname)"
                      echo "Running from directory: $(pwd)"

name: Docker CI/CD for Node.js App

on:
  push:
    branches:
      - main

env:
  DOCKER_IMAGE_NAME: docker-ts-backend
  IMAGE_TAG: v1
  CONTAINER_NAME: docker-ts-backend-container
  DOCKER_VOLUME: docker-ts-backend-volume

jobs:
  verify-connection:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify SSH Connection
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          timeout: 30s
          script: |
            echo "SSH OK"
            hostname
            whoami
            echo "Docker version:"
            docker --version

  build:
    runs-on: ubuntu-latest
    needs: verify-connection

    steps:
      - uses: actions/checkout@v4

      - name: Build Docker Image
        run: |
          docker build \
            -t $DOCKER_IMAGE_NAME:$IMAGE_TAG \
            .

      - name: Verify Image Exists
        run: docker images

      - name: Save Docker Image
        run: |
          docker save \
            $DOCKER_IMAGE_NAME:$IMAGE_TAG \
            -o docker-image.tar

      - name: Upload Docker Image
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: docker-image.tar
          retention-days: 1

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Copy Image to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: docker-image.tar
          target: /home/ubuntu/

      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          timeout: 120s
          script: |
            set -e

            echo "ğŸ“ Files on EC2 before deployment:"
            ls -la /home/ubuntu/

            # Load Docker image
            echo "ğŸ“¦ Loading Docker image..."
            sudo docker load -i /home/ubuntu/docker-image.tar

            # Verify image loaded
            echo "âœ… Images after load:"
            sudo docker images | grep docker-ts-backend

            # Stop and remove existing container
            echo "ğŸ›‘ Stopping existing container..."
            sudo docker stop docker-ts-backend-container 2>/dev/null || echo "No container to stop"
            sudo docker rm docker-ts-backend-container 2>/dev/null || echo "No container to remove"

            # Create volume if not exists
            echo "ğŸ“ Creating Docker volume..."
            sudo docker volume create docker-ts-backend-volume 2>/dev/null || echo "Volume already exists"

            # Check if .env file exists
            echo "ğŸ” Checking for .env file..."
            if [ -f /home/ubuntu/.env ]; then
              echo "âœ… Found .env file, using it"
              # Run with .env file
              sudo docker run -d \
                --name docker-ts-backend-container \
                -p 5000:5000 \
                -v docker-ts-backend-volume:/app/logs \
                --env-file /home/ubuntu/.env \
                --restart always \
                docker-ts-backend:v1
            else
              echo "âš ï¸ No .env file found"
              # Run without .env file
              sudo docker run -d \
                --name docker-ts-backend-container \
                -p 5000:5000 \
                -v docker-ts-backend-volume:/app/logs \
                --restart always \
                docker-ts-backend:v1
            fi

            # Wait a moment
            sleep 5

            # Verify deployment
            echo "ğŸ” Verifying deployment..."
            sudo docker ps --filter "name=docker-ts-backend-container"

            echo "ğŸ“ Container logs (last 10 lines):"
            sudo docker logs --tail 10 docker-ts-backend-container 2>/dev/null || echo "No logs yet"

            echo "âœ… Deployment complete!"

            echo ""
            echo "ğŸŒ Application URL: http://$(hostname -I | awk '{print $1}'):5000"
            echo "   or: http://${{ secrets.EC2_HOST }}:5000"

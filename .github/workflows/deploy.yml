name: Docker CI/CD for Node.js App

on:
  push:
    branches:
      - main

env:
  DOCKER_IMAGE_NAME: docker-ts-backend
  IMAGE_TAG: v1
  CONTAINER_NAME: docker-ts-backend-container
  DOCKER_VOLUME: docker-ts-backend-volume

jobs:
  verify-connection:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify SSH Connection
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }} # FIXED: EC2_JIOST not EC2_HOST
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }} # FIXED: EC2_SSIL_KEY not EC2_SSH_KEY
          timeout: 30s
          script: |
            echo "SSH OK"
            hostname
            whoami
            echo "Current directory: $(pwd)"
            ls -la

  build:
    runs-on: ubuntu-latest
    needs: verify-connection

    steps:
      - uses: actions/checkout@v4

      - name: Build Docker Image
        run: |
          docker build \
            -t $DOCKER_IMAGE_NAME:$IMAGE_TAG \
            .

      - name: Verify Image Exists
        run: docker images

      - name: Save Docker Image
        run: |
          docker save \
            $DOCKER_IMAGE_NAME:$IMAGE_TAG \
            -o docker-image.tar

      - name: Upload Docker Image
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: docker-image.tar
          retention-days: 1

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download Docker Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Debug - Check Downloaded File
        run: |
          echo "Checking downloaded file..."
          ls -lh docker-image.tar
          file docker-image.tar

      - name: Copy Image to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }} # FIXED: EC2_JIOST not EC2_HOST
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }} # FIXED: EC2_SSIL_KEY not EC2_SSH_KEY
          source: docker-image.tar
          target: /home/ubuntu/

      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }} # FIXED: EC2_JIOST not EC2_HOST
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }} # FIXED: EC2_SSIL_KEY not EC2_SSH_KEY
          timeout: 120s
          envs: |
            CONTAINER_NAME=docker-ts-backend-container
            DOCKER_VOLUME=docker-ts-backend-volume
            DOCKER_IMAGE_NAME=docker-ts-backend
            IMAGE_TAG=v1
          script: |
            set -e

            # Debug: Show what's on EC2
            echo "ðŸ“ Files on EC2 before deployment:"
            ls -la /home/ubuntu/

            # Load Docker image
            echo "ðŸ“¦ Loading Docker image..."
            sudo docker load -i /home/ubuntu/docker-image.tar

            # Verify image loaded
            echo "âœ… Images after load:"
            sudo docker images | grep docker-ts-backend

            # Stop and remove existing container
            echo "ðŸ›‘ Stopping existing container..."
            sudo docker stop $CONTAINER_NAME 2>/dev/null || echo "No container to stop"
            sudo docker rm $CONTAINER_NAME 2>/dev/null || echo "No container to remove"

            # Create volume if not exists
            echo "ðŸ“ Creating Docker volume..."
            sudo docker volume create $DOCKER_VOLUME 2>/dev/null || echo "Volume already exists"

            # Check if .env file exists
            echo "ðŸ” Checking for .env file..."
            if [ -f /home/ubuntu/.env ]; then
              echo "âœ… Found .env file, using it"
              ENV_FILE_OPTION="--env-file /home/ubuntu/.env"
            else
              echo "âš ï¸ No .env file found"
              ENV_FILE_OPTION=""
            fi

            # Run new container
            echo "ðŸš€ Starting new container..."
            if [ -n "$ENV_FILE_OPTION" ]; then
              sudo docker run -d \
                --name $CONTAINER_NAME \
                --restart always \
                -p 5000:5000 \
                -v $DOCKER_VOLUME:/app/logs \
                $ENV_FILE_OPTION \
                $DOCKER_IMAGE_NAME:$IMAGE_TAG
            else
              sudo docker run -d \
                --name $CONTAINER_NAME \
                --restart always \
                -p 5000:5000 \
                -v $DOCKER_VOLUME:/app/logs \
                $DOCKER_IMAGE_NAME:$IMAGE_TAG
            fi

            # Wait a moment
            sleep 5

            # Verify deployment
            echo "ðŸ” Verifying deployment..."
            sudo docker ps --filter "name=$CONTAINER_NAME"

            echo "ðŸ“ Container logs:"
            sudo docker logs --tail 10 $CONTAINER_NAME 2>/dev/null || echo "No logs yet"

            echo "âœ… Deployment complete!"

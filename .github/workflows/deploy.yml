name: Docker CI/CD for Node.js App

on:
    push:
        branches:
            - main

env:
    DOCKER_IMAGE_NAME: docker-ts-backend
    CONTAINER_NAME: docker-ts-backend-container
    DOCKER_VOLUME: docker-ts-backend-volume

jobs:
    verify-connection:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Verify SSH Connection
              uses: appleboy/ssh-action@v1
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER || 'ubuntu' }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  timeout: 30s
                  command_timeout: 30s
                  script: |
                      echo "âœ… SSH Connection Successful!"
                      echo "Connected to: $(hostname)"
                      echo "IP Address: $(hostname -I)"
                      echo "Current directory: $(pwd)"

    build:
        runs-on: ubuntu-latest
        needs: verify-connection

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker Image
              run: |
                  docker build \
                    --tag ${{ env.DOCKER_IMAGE_NAME }}:latest \
                    --file Dockerfile \
                    .

            - name: Save Docker Image
              run: |
                  docker save ${{ env.DOCKER_IMAGE_NAME }}:latest -o ${{ env.DOCKER_IMAGE_NAME }}.tar

            - name: Upload Docker Image
              uses: actions/upload-artifact@v4
              with:
                  name: docker-image
                  path: ${{ env.DOCKER_IMAGE_NAME }}.tar
                  retention-days: 1

    deploy:
        runs-on: ubuntu-latest
        needs: build

        steps:
            - name: Download Docker Image
              uses: actions/download-artifact@v4
              with:
                  name: docker-image
                  path: ./

            - name: Deploy to EC2
              uses: appleboy/ssh-action@v1
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER || 'ubuntu' }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  timeout: 60s
                  command_timeout: 120s
                  script: |
                      # Load the Docker image
                      echo "ðŸ“¦ Loading Docker image..."
                      docker load < ${{ env.DOCKER_IMAGE_NAME }}.tar

                      # Stop and remove existing container
                      echo "ðŸ›‘ Stopping existing container..."
                      docker stop ${{ env.CONTAINER_NAME }} 2>/dev/null || true
                      docker rm ${{ env.CONTAINER_NAME }} 2>/dev/null || true

                      # Create volume if it doesn't exist
                      docker volume create ${{ env.DOCKER_VOLUME }} 2>/dev/null || true

                      # Run new container
                      echo "ðŸš€ Starting new container..."
                      docker run -d \
                        -p 5000:5000 \
                        --name ${{ env.CONTAINER_NAME }} \
                        -v ${{ env.DOCKER_VOLUME }}:/app/logs \
                        --restart always \
                        ${{ env.DOCKER_IMAGE_NAME }}:latest

                      # Wait for container to start
                      sleep 5

                      # Verify deployment
                      echo "ðŸ” Verifying deployment..."
                      if docker ps --filter "name=${{ env.CONTAINER_NAME }}" --format "table {{.Names}}\t{{.Status}}" | grep -q "${{ env.CONTAINER_NAME }}"; then
                        echo "âœ… Deployment successful!"
                        echo "Container status:"
                        docker ps --filter "name=${{ env.CONTAINER_NAME }}"
                      else
                        echo "âŒ Deployment failed!"
                        echo "Container logs:"
                        docker logs ${{ env.CONTAINER_NAME }} 2>/dev/null || echo "No logs available"
                        exit 1
                      fi
              env:
                  DOCKER_IMAGE_NAME: ${{ env.DOCKER_IMAGE_NAME }}
                  CONTAINER_NAME: ${{ env.CONTAINER_NAME }}
                  DOCKER_VOLUME: ${{ env.DOCKER_VOLUME }}

name: Test EC2 Connection

on: [push]

jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Display EC2_HOST (for debugging, mask the value)
              run: |
                  echo "EC2_HOST is set: ${{ secrets.EC2_HOST != '' }}"
                  # To see the actual value (be careful, it will be logged)
                  # echo "EC2_HOST=${{ secrets.EC2_HOST }}"

            - name: Test network connectivity to EC2_HOST
              run: |
                  # Use ping to check if the host is reachable (ICMP may be blocked, so we also try port 22)
                  echo "Testing connectivity to ${{ secrets.EC2_HOST }}"
                  if ping -c 2 ${{ secrets.EC2_HOST }} &> /dev/null; then
                    echo "Ping successful"
                  else
                    echo "Ping failed (may be blocked)"
                  fi
                  # Test port 22
                  if nc -z -w 2 ${{ secrets.EC2_HOST }} 22; then
                    echo "Port 22 is open"
                  else
                    echo "Port 22 is not reachable"
                  fi

            - name: Attempt SSH connection
              uses: appleboy/ssh-action@v1
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ubuntu
                  key: ${{ secrets.EC2_SSH_KEY }}
                  timeout: 30s
                  command_timeout: 30s
                  script: |
                      echo "Connected!"
                      hostname
